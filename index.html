<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SureTask</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --light-bg: #f3f4f6; --light-card-bg: #ffffff; --light-text: #111827; --light-secondary-text: #6b7280; --light-border: #e5e7eb;
            --dark-bg: #1f2937; --dark-card-bg: #374151; --dark-text: #f9fafb; --dark-secondary-text: #9ca3af; --dark-border: #4b5563;
            --accent-color: #5856d6; --gold: #ffc700; --silver: #d1d5db; --bronze: #f09a5d;
        }
        body.light { --bg-color: var(--light-bg); --card-bg-color: var(--light-card-bg); --text-color: var(--light-text); --secondary-text-color: var(--light-secondary-text); --border-color: var(--light-border); }
        body.dark { --bg-color: var(--dark-bg); --card-bg-color: var(--dark-card-bg); --text-color: var(--dark-text); --secondary-text-color: var(--dark-secondary-text); --border-color: var(--dark-border); }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 20px 20px 80px 20px; background-color: var(--bg-color); color: var(--text-color); }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Home View */
        .profile-card { text-align: center; margin-bottom: 20px; }
        .profile-pic { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 10px; border: 4px solid var(--bg-color); box-shadow: 0 4px 10px rgba(0,0,0,0.1); background-color: #ccc; }
        .username { font-size: 22px; font-weight: 600; }
        .points-display { display: inline-block; background: linear-gradient(90deg, #4c66ee, #5c3ce0); color: white; padding: 8px 30px; border-radius: 20px; font-size: 16px; font-weight: 500; margin-top: 5px; }
        .welcome-card { background: var(--card-bg-color); padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px; }
        .welcome-card h2 { margin: 0 0 5px 0; font-size: 20px; }
        .welcome-card p { color: var(--secondary-text-color); margin: 0 0 20px 0; }
        .join-channel-btn { width: 100%; padding: 15px; background: #2f80ed; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        
        /* Leaderboard View */
        .page-header { display: flex; align-items: center; margin-bottom: 25px; }
        .page-header .title { font-size: 22px; font-weight: 600; }
        .leaderboard-item { display: flex; align-items: center; background-color: var(--card-bg-color); padding: 12px; border-radius: 15px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .leaderboard-rank { font-weight: 600; font-size: 16px; width: 40px; text-align: center; color: var(--secondary-text-color); }
        .rank-icon { font-size: 24px; display: block; }
        .leaderboard-item.rank-1 .rank-icon { color: var(--gold); }
        .leaderboard-item.rank-2 .rank-icon { color: var(--silver); }
        .leaderboard-item.rank-3 .rank-icon { color: var(--bronze); }
        .leaderboard-pic { width: 50px; height: 50px; border-radius: 50%; margin: 0 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; font-size: 24px; border: 2px solid rgba(128,128,128,0.1); }
        .leaderboard-info { flex-grow: 1; min-width: 0; }
        .leaderboard-info .name { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .leaderboard-info .points { font-size: 13px; color: var(--secondary-text-color); margin-top: 2px; }
        .leaderboard-refs { text-align: right; color: var(--secondary-text-color); font-size: 14px; display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .list-item-link { text-decoration: none; color: inherit; display: contents; }
        .leaderboard-item.rank-1 { border: 2px solid var(--gold); }
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-top: 1px solid var(--border-color); }
        .nav-item { cursor: pointer; text-align: center; color: var(--secondary-text-color); font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 4px; flex-grow: 1; }
        .nav-item .icon { font-size: 24px; }
        .nav-item.active { color: var(--accent-color); }
    </style>
</head>
<body>

    <div id="home-view" class="view active">
        <div class="profile-card">
            <img id="profilePic" class="profile-pic" src="" alt="">
            <h1 id="username" class="username">Loading...</h1>
            <div id="points" class="points-display">0 Points</div>
        </div>
        <div class="welcome-card">
            <h2 id="welcome-name">Welcome!</h2>
            <p>Complete tasks, invite friends, and earn points.</p>
            <button id="join-channel-btn" class="join-channel-btn"><i class='bx bxl-telegram'></i> Join Channel</button>
        </div>
    </div>

    <div id="leaderboard-view" class="view">
        <div class="page-header"><h1 class="title">üèÜ Leaderboard</h1></div>
        <div id="leaderboard-list"></div>
        <div id="leaderboard-loading" style="text-align: center; margin-top: 50px;">Loading...</div>
    </div>

    <!-- ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï, ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø future views ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá -->
    <div id="tasks-view" class="view"><div class="page-header"><h1 class="title">üìã Tasks</h1></div><p>Tasks will be available soon.</p></div>
    <div id="bonus-view" class="view"><div class="page-header"><h1 class="title">üéÅ Bonus</h1></div><p>Bonus section is coming soon.</p></div>
    <div id="withdraw-view" class="view"><div class="page-header"><h1 class="title">üí∏ Withdraw</h1></div><p>Withdrawal options will be here.</p></div>
    <div id="history-view" class="view"><div class="page-header"><h1 class="title">üìú History</h1></div><p>Your transaction history will appear here.</p></div>
    <div id="referral-view" class="view"><div class="page-header"><h1 class="title">üë• Referral</h1></div><p>Refer your friends and earn.</p></div>
    
    <nav class="bottom-nav">
        <div class="nav-item active" data-view="home-view"><i class='bx bxs-home icon'></i>Home</div>
        <div class="nav-item" data-view="tasks-view"><i class='bx bxs-server icon'></i>Tasks</div>
        <div class="nav-item" data-view="bonus-view"><i class='bx bxs-gift icon'></i>Bonus</div>
        <div class="nav-item" data-view="withdraw-view"><i class='bx bxs-wallet icon'></i>Withdraw</div>
        <div class="nav-item" data-view="history-view"><i class='bx bx-history icon'></i>History</div>
        <div class="nav-item" data-view="referral-view"><i class='bx bxs-user-plus icon'></i>Referral</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Basic Setup ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.add(savedTheme);
        const tg = window.Telegram.WebApp;

        // --- Navigation Logic ---
        const views = document.querySelectorAll('.view');
        const navItems = document.querySelectorAll('.nav-item');
        
        function navigate(viewId) {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            navItems.forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            // ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            if (viewId === 'leaderboard-view') {
                loadLeaderboard();
            }
        }
        
        navItems.forEach(item => {
            item.addEventListener('click', () => navigate(item.dataset.view));
        });

        // --- Channel Join Button ---
        document.getElementById('join-channel-btn').addEventListener('click', () => {
            // ‡¶è‡¶á ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶¶‡¶ø‡ßü‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            tg.openTelegramLink("https://t.me/YourChannelUsername");
        });

        // --- App Initialization ---
        async function initializeAndRunApp() {
            try {
                const response = await fetch('/api/config');
                const firebaseConfig = await response.json();
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                runTelegramLogic(db);
            } catch (error) { console.error("Initialization Failed:", error); }
        }

        function runTelegramLogic(db) {
            try {
                tg.ready();
                tg.expand();
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    const profilePicEl = document.getElementById('profilePic');
                    if (user.photo_url) { profilePicEl.src = user.photo_url; } else { profilePicEl.style.display = 'none'; }
                    document.getElementById('username').innerText = user.first_name || 'User';
                    document.getElementById('welcome-name').innerText = `Welcome, ${user.first_name}!`;
                    loadUserDataFromFirebase(db, user.id);
                } else { document.getElementById('username').innerText = 'Open in Telegram'; }
            } catch (e) { document.getElementById('username').innerText = 'Open in Telegram'; }
        }

        async function loadUserDataFromFirebase(db, userId) {
            try {
                const userRef = doc(db, "users", String(userId));
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    document.getElementById('points').innerText = `${docSnap.data().points || 0} Points`;
                }
            } catch (error) { console.error("Error fetching user data:", error); }
        }

        // --- Leaderboard Logic ---
        function generateColor(str) {
            let hash = 0;
            for (let i = 0; i < (str || '').length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

        async function loadLeaderboard() {
            const listContainer = document.getElementById('leaderboard-list');
            const loadingDiv = document.getElementById('leaderboard-loading');
            loadingDiv.style.display = 'block';
            listContainer.innerHTML = '';

            try {
                const response = await fetch('/api/leaderboard');
                const users = await response.json();
                loadingDiv.style.display = 'none';
                if (!users || users.length === 0) { listContainer.innerHTML = '<p style="text-align:center;color:#aaa;">Leaderboard is empty.</p>'; return; }

                users.forEach((user, index) => {
                    const rank = index + 1;
                    const profileLink = user.username ? `https://t.me/${user.username}` : `tg://user?id=${user.id}`;
                    const userInitial = user.first_name ? user.first_name.charAt(0).toUpperCase() : '?';
                    const userColor = generateColor(user.first_name);
                    let rankDisplay = `#${rank}`;
                    if (rank <= 3) { rankDisplay = `<i class='bx bxs-crown rank-icon'></i>`; }

                    const item = document.createElement('div');
                    item.className = `leaderboard-item rank-${rank}`;
                    item.innerHTML = `
                        <div class="leaderboard-rank">${rankDisplay}</div>
                        <a href="${profileLink}" class="list-item-link" target="_blank" style="display:contents;">
                            <div class="leaderboard-pic" style="background-color: ${userColor};">${userInitial}</div>
                            <div class="leaderboard-info">
                                <div class="name">${escapeHTML(user.first_name)}</div>
                                <div class="points">${user.points || 0} Points</div>
                            </div>
                            <div class="leaderboard-refs">
                                <i class='bx bxs-user-plus'></i>
                                <span>${user.referrals || 0}</span>
                            </div>
                        </a>
                    `;
                    listContainer.appendChild(item);
                });
            } catch (err) {
                loadingDiv.innerText = 'Could not load leaderboard.';
            }
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.appendChild(document.createTextNode(str || ''));
            return p.innerHTML;
        }

        window.addEventListener('load', initializeAndRunApp);
    </script>
</body>
</html>
