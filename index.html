<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SureTask</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        /* আপনার সব CSS কোড অপরিবর্তিত থাকবে */
    </style>
</head>
<body class="light">
    
    <div id="app-container"></div>
    
    <nav class="bottom-nav">
        <!-- আপনার নেভিগেশন বার অপরিবর্তিত থাকবে -->
    </nav>
    <input type="file" id="photo-upload-input" class="hidden" accept="image/*">

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- firestoreDb ভ্যারিয়েবল যোগ করা হয়েছে ---
    let db, firestoreDb, storage, tg, currentUser = {}, userId;

    async function initializeApp() {
        try {
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('Config fetch failed');
            const firebaseConfig = await response.json();
            
            firebase.initializeApp(firebaseConfig);
            db = firebase.database(); // Realtime DB (লিডারবোর্ড ও ছবির জন্য)
            firestoreDb = firebase.firestore(); // Firestore (প্রধান তথ্যের জন্য)
            storage = firebase.storage();
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            userId = tg.initDataUnsafe?.user?.id || 'test_user';

           // tg.showAlert("Welcome! Please be aware of our terms and conditions.");
            
            setupTheme();
            setupNavigation();
            runUserLogic();
        } catch (error) { document.getElementById('app-container').innerHTML = `<h1>App Failed to Load</h1><p>${error.message}</p>`; }
    }

    // --- runUserLogic ফাংশনটি Firestore ব্যবহার করার জন্য আপডেট করা হয়েছে ---
    function runUserLogic() {
        const userDocRef = firestoreDb.collection('users').doc(String(userId));

        // onSnapshot ব্যবহার করা হয়েছে যাতে পয়েন্ট রিয়েল-টাইমে আপডেট হয়
        userDocRef.onSnapshot((doc) => {
            const freshName = tg.initDataUnsafe?.user?.first_name || 'User';
            const freshUsername = tg.initDataUnsafe?.user?.username || null;
            
            if (doc.exists) {
                currentUser = doc.data();
                // Realtime Database-এ নাম এবং ইউজারনেম সিঙ্ক করা হচ্ছে (ঐচ্ছিক কিন্তু ভালো)
                const updates = {};
                if (currentUser.name !== freshName) updates.name = freshName;
                if (currentUser.username !== freshUsername) updates.username = freshUsername;
                if (Object.keys(updates).length > 0) {
                    db.ref(`users/${userId}`).update(updates);
                }
            } else {
                // যদি Firestore-এ ইউজার না থাকে, তাহলে তৈরি করা হচ্ছে
                currentUser = { 
                    id: String(userId), name: freshName, username: freshUsername, 
                    points: 0, referralCount: 0, referralEarnings: 0,
                    createdAt: new Date() // Firestore Timestamp ব্যবহার করবে
                };
                userDocRef.set(currentUser);

                // সাথে সাথে Realtime Database-এও একটি বেসিক প্রোফাইল তৈরি করা হচ্ছে
                db.ref(`users/${userId}`).set({
                    name: freshName,
                    username: freshUsername
                });
            }
            
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const viewName = activeNav.id.split('-')[1];
                 if (viewName !== 'referral') {
                    renderView(viewName);
                 }
            }
        }, (error) => {
            console.error("Error fetching user data from Firestore:", error);
            document.getElementById('app-container').innerHTML = `<h1>Could not load user data.</h1>`;
        });
    }

    // --- Leaderboard ফাংশনটি Firestore ব্যবহার করার জন্য আপডেট করা হয়েছে ---
    function renderLeaderboardPage(container) {
        container.innerHTML = `
            <div class="page-header">
                <button class="back-button" onclick="renderView('home')"><i class='bx bx-arrow-back'></i></button>
                <h1 class="title">Leaderboard</h1>
            </div>
            <div id="leaderboard-list" class="view">Loading...</div>`;
        
        // Firestore থেকে পয়েন্ট অনুযায়ী সেরা ৫০ জন ব্যবহারকারীকে আনা হচ্ছে
        firestoreDb.collection('users').orderBy('points', 'desc').limit(50).get()
            .then(snapshot => {
                const list = document.getElementById('leaderboard-list');
                if (snapshot.empty) {
                    list.innerHTML = 'Leaderboard is empty.';
                    return;
                }
                
                list.innerHTML = '';
                snapshot.docs.forEach((doc, index) => {
                    const user = doc.data();
                    const rank = index + 1;
                    const item = document.createElement('div');
                    item.className = `leaderboard-item rank-${rank}`;
                    
                    // Realtime Database থেকে ছবির লিঙ্ক আনা যেতে পারে
                    // অথবা Firestore-এই ছবির লিঙ্ক সেভ করা যেতে পারে
                    const profileLink = user.username ? `https://t.me/${user.username}` : `tg://user?id=${user.id}`;
                    let rankDisplay = `#${rank}`;
                    if(rank <= 3) {
                        const iconClass = rank === 1 ? 'bxs-crown' : (rank === 2 ? 'bxs-shield-alt-2' : 'bxs-star');
                        rankDisplay = `<div class="rank-icon"><i class='bx ${iconClass}'></i></div>`;
                    }

                    item.innerHTML = `
                        <div class="leaderboard-rank">${rankDisplay}</div>
                        <a href="${profileLink}" target="_blank" style="display:contents;">
                            <div id="leaderboard-pic-${user.id}" class="leaderboard-pic"></div>
                            <div class="leaderboard-info">
                                <div class="name">${user.customName || user.name || 'User'}</div>
                                <div class="leaderboard-stats">
                                    <div class="points">${user.points || 0} Points</div>
                                    <div class="referrals"><i class='bx bxs-user-plus'></i><span>${user.referralCount || 0}</span></div>
                                </div>
                            </div>
                        </a>`;
                    list.appendChild(item);
                    // প্রোফাইল ছবি রেন্ডার করার জন্য আপনার পুরনো ফাংশনটি ব্যবহার করা হচ্ছে
                    renderProfilePic(document.getElementById(`leaderboard-pic-${user.id}`), user.name, user.profilePhotoUrl || user.initialPhotoUrl);
                });
            })
            .catch(error => {
                console.error("Error fetching leaderboard:", error);
                document.getElementById('leaderboard-list').innerHTML = `<p>Could not load leaderboard.</p>`;
            });
    }

    // --- প্রোফাইল ছবি এবং নাম পরিবর্তনের জন্য Realtime Database ব্যবহার করা হচ্ছে ---
    function handlePhotoUpload(event) {
        // ... এই ফাংশনটি অপরিবর্তিত ...
    }
    
    function saveProfileChanges() {
        // ... এই ফাংশনটি অপরিবর্তিত ...
    }

    // --- বাকি সব ফাংশন অপরিবর্তিত থাকবে ---
    function setupTheme() { /* ... */ }
    function updateThemeIcon() { /* ... */ }
    function setupNavigation() { /* ... */ }
    function renderView(viewName) { /* ... */ }
    function renderHomePage(container) { /* ... */ }
    function renderProfilePage(container) { /* ... */ }
    function renderProfilePic(container, name, photoUrl) { /* ... */ }
    function generateColor(str) { /* ... */ }

    initializeApp();
});
</script>
</body>
</html>
