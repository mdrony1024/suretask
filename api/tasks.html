<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tasks</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶è‡¶ï‡¶á ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body { margin: 0; padding: 20px; background-color: #12121f; color: white; font-family: 'Roboto', sans-serif; }
        .header { display: flex; align-items: center; margin-bottom: 25px; }
        .header h1 { margin: 0 0 0 15px; font-size: 24px; }
        .back-button { background: none; border: none; color: white; font-size: 28px; cursor: pointer; }
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; background-color: #1e1e3f; padding: 15px; border-radius: 12px; margin-bottom: 10px; justify-content: space-between; }
        .task-info .title { font-weight: 500; font-size: 16px; }
        .task-info .points { font-size: 14px; color: #34d399; margin-top: 4px; }
        .task-button { background-color: #4a00e0; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .task-button:disabled { background-color: #555; cursor: not-allowed; }
        #loading { text-align: center; margin-top: 50px; font-size: 18px; color: #aaa; }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="window.location.href='/index.html'" class="back-button">&larr;</button>
        <h1>üìã Available Tasks</h1>
    </div>
    
    <ul id="taskList" class="task-list"></ul>
    <div id="loading">Loading tasks...</div>

    <script>
        let tg;
        let userId;

        window.addEventListener('load', () => {
            tg = window.Telegram.WebApp;
            tg.ready();
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#12121f';
            
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id;
                fetchTasks();
            } else {
                document.getElementById('loading').innerText = 'Please open in Telegram.';
            }
        });

        async function fetchTasks() {
            const listElement = document.getElementById('taskList');
            const loadingElement = document.getElementById('loading');
            try {
                const response = await fetch('/api/tasks');
                const tasks = await response.json();
                
                loadingElement.style.display = 'none';

                if (tasks.length === 0) {
                    listElement.innerHTML = '<p style="text-align: center; color: #aaa;">No tasks available right now.</p>';
                    return;
                }

                tasks.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.className = 'task-item';
                    listItem.innerHTML = `
                        <div class="task-info">
                            <div class="title">${escapeHTML(task.title)}</div>
                            <div class="points">+${task.points} Points</div>
                        </div>
                        <button class="task-button" id="task-${task.id}">Start</button>
                    `;
                    listElement.appendChild(listItem);

                    // ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                    document.getElementById(`task-${task.id}`).addEventListener('click', () => {
                        startTask(task.id, task.link, `task-${task.id}`);
                    });
                });
            } catch (error) {
                loadingElement.innerText = 'Failed to load tasks.';
                console.error('Error fetching tasks:', error);
            }
        }
        
        function startTask(taskId, link, buttonId) {
            const button = document.getElementById(buttonId);
            button.innerText = 'Verify';
            // ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            tg.openTelegramLink(link);

            // ‡¶è‡¶ñ‡¶® ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§
            button.onclick = () => completeTask(taskId, buttonId);
        }

        async function completeTask(taskId, buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.innerText = 'Verifying...';

            try {
                const response = await fetch('/api/complete-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, taskId: taskId })
                });

                const result = await response.json();

                if (response.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    button.innerText = 'Done ‚úî';
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                    button.innerText = result.error || 'Failed';
                    tg.showAlert(result.error || 'Verification failed. Please try again.');
                }
            } catch (error) {
                 tg.HapticFeedback.notificationOccurred('error');
                 button.innerText = 'Error';
                 tg.showAlert('An error occurred.');
            }
        }

        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>
