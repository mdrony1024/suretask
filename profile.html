<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>My Profile - SureTask</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { /* Styles are consistent with other pages */ }
        body.dark-mode { /* Dark mode styles */ }
        /* Common styles from other pages... */
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 20px; /* ... */ }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-color); }
        .form-group input { width: 100%; padding: 12px; box-sizing: border-box; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-color); font-size: 14px; }
        .save-button { width: 100%; padding: 15px; background-color: var(--accent-color, #5856d6); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .save-button:disabled { background-color: #ccc; }
        .profile-upload-container { text-align: center; margin-bottom: 25px; }
        .profile-pic-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); background-color: #eee; cursor: pointer; }
        #image-upload-input { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <a href="/index.html" class="back-button"><i class='bx bx-arrow-back'></i></a>
        <h1 class="title">Edit Profile</h1>
    </div>

    <div class="profile-upload-container">
        <img id="profile-pic-preview" class="profile-pic-preview" src="" alt="Tap to upload">
        <input type="file" id="image-upload-input" accept="image/png, image/jpeg">
        <p style="font-size: 12px; color: var(--secondary-text-color);">Tap image to change</p>
    </div>

    <div class="form-group">
        <label for="username-input">Custom Username</label>
        <input type="text" id="username-input" placeholder="Enter a unique username">
    </div>

    <button id="save-profile-btn" class="save-button">Save Changes</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- Basic Setup ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.classList.add(savedTheme);
        const tg = window.Telegram.WebApp;
        tg.ready();
        let db, storage, currentUser;

        // --- Elements ---
        const previewImg = document.getElementById('profile-pic-preview');
        const uploadInput = document.getElementById('image-upload-input');
        const usernameInput = document.getElementById('username-input');
        const saveBtn = document.getElementById('save-profile-btn');

        // --- Functions ---
        async function initializeAppWithConfig() {
            const response = await fetch('/api/config');
            const firebaseConfig = await response.json();
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
            loadProfileData();
        }

        async function loadProfileData() {
            if (!tg.initDataUnsafe?.user) { alert('Could not load user data.'); return; }
            currentUser = tg.initDataUnsafe.user;
            const userRef = doc(db, 'users', String(currentUser.id));
            const userDoc = await getDoc(userRef);

            if (userDoc.exists()) {
                const data = userDoc.data();
                usernameInput.value = data.customUsername || '';
                previewImg.src = data.customPhotoUrl || '/default-avatar.png'; // Use a default avatar if none
            }
             previewImg.onerror = () => { previewImg.src = '/default-avatar.png'; };
        }

        async function saveProfile() {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            const userId = String(currentUser.id);
            const newUsername = usernameInput.value.trim();
            const file = uploadInput.files[0];

            try {
                let photoUrl = previewImg.src; // Keep old photo if new one isn't uploaded
                if (file) {
                    const storageRef = ref(storage, `profile_pics/${userId}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    photoUrl = await getDownloadURL(snapshot.ref);
                }

                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, {
                    customUsername: newUsername,
                    customPhotoUrl: photoUrl
                });

                tg.showAlert('Profile updated successfully!');
            } catch (error) {
                console.error("Error saving profile: ", error);
                tg.showAlert('Failed to save profile. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // --- Event Listeners ---
        previewImg.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                previewImg.src = URL.createObjectURL(file);
            }
        });
        saveBtn.addEventListener('click', saveProfile);

        // --- Initial Load ---
        initializeAppWithConfig();
    </script>
</body>
</html>
