<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SureTask - Available Tasks</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --dark-bg: #1f2937; --dark-card-bg: #374151; --dark-text: #f9fafb; 
            --secondary-text: #9ca3af; --border-color: #4b5563;
            --accent-color: #5856d6; --success: #22c55e; --daily-color: #f59e0b;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--dark-bg); color: var(--dark-text); }
        .view { padding: 0 15px; }
        .page-header { display: flex; align-items: center; padding: 15px; }
        .back-button { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--dark-text); margin-right: 10px; }
        .page-header .title { font-size: 20px; font-weight: 600; }
        .section-title { font-size: 18px; font-weight: 600; margin-top: 25px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--accent-color); }
        .task-card { background-color: var(--dark-card-bg); border-radius: 15px; padding: 20px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .task-card.daily::before { content: 'DAILY'; position: absolute; top: 10px; right: -25px; background: var(--daily-color); color: white; padding: 4px 30px; font-size: 10px; font-weight: bold; transform: rotate(45deg); }
        .task-info h3 { margin: 0; font-size: 18px; font-weight: 600; }
        .task-info .points { color: var(--success); font-weight: 600; font-size: 16px; margin-top: 5px; }
        .task-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .task-btn { padding: 12px; border-radius: 12px; border: none; font-size: 16px; font-weight: 500; cursor: pointer; }
        .join-btn { background-color: var(--accent-color); color: white; }
        .verify-btn { background-color: #4b5563; color: var(--dark-text); }
        .verify-btn:disabled { background-color: var(--success); color: white; cursor: not-allowed; }
        .no-tasks { text-align: center; margin-top: 50px; color: var(--secondary-text); }
    </style>
</head>
<body class="dark">
    
    <div class="page-header">
        <button class="back-button" onclick="window.location.href='tasks_home.html'"><i class='bx bx-arrow-back'></i></button>
        <h1 id="page-title" class="title">Tasks</h1>
    </div>

    <div id="tasks-container" class="view"></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    let tg, firestoreDb, userId;
    const categoryNames = {
        group: "TG Group Tasks",
        channel: "TG Channel Tasks",
        tg_views: "Telegram Views Tasks",
        yt_views: "YouTube Views Tasks",
        bot_start: "Bot START Tasks"
    };

    async function initializeApp() {
        try {
            const response = await fetch('/api/config');
            if (!response.ok) throw new Error('Config fetch failed');
            const firebaseConfig = await response.json();
            
            firebase.initializeApp(firebaseConfig);
            firestoreDb = firebase.firestore();
            
            tg = window.Telegram.WebApp;
            tg.ready();
            
            userId = tg.initDataUnsafe?.user?.id;
            if (!userId) {
                document.getElementById('tasks-container').innerHTML = '<div class="no-tasks"><h3>Could not verify user.</h3></div>';
                return;
            }
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.className = savedTheme;

            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            
            if (category) {
                document.getElementById('page-title').innerText = categoryNames[category] || "Tasks";
                await loadAllTasks(category);
            } else {
                document.getElementById('tasks-container').innerHTML = `<div class="no-tasks"><h3>No category selected.</h3></div>`;
            }
        } catch (error) {
            document.getElementById('tasks-container').innerHTML = `<h1 class="no-tasks">Page Failed to Load: ${error.message}</h1>`;
        }
    }

    async function loadAllTasks(category) {
        const container = document.getElementById('tasks-container');
        container.innerHTML = `<p style="text-align:center;">Loading tasks...</p>`;

        try {
            const historySnapshot = await firestoreDb.collection('userTaskHistory').where('userId', '==', String(userId)).get();
            const completedTasks = {};
            historySnapshot.forEach(doc => {
                completedTasks[doc.data().taskId] = doc.data().lastCompleted;
            });
            
            const [adminTasksSnapshot, promotionTasksSnapshot] = await Promise.all([
                firestoreDb.collection('tasks').where('category', '==', category).get(),
                firestoreDb.collection('promotions').where('category', '==', category).where('status', '==', 'active').get()
            ]);

            let adminTasksHTML = '';
            let promotionTasksHTML = '';
            const today = new Date().toISOString().slice(0, 10);
            
            adminTasksSnapshot.forEach(doc => {
                const taskId = doc.id;
                const task = doc.data();
                let shouldShow = true;

                if (completedTasks[taskId]) {
                    if (task.taskType === 'daily') {
                        if (completedTasks[taskId] === today) shouldShow = false;
                    } else {
                        shouldShow = false;
                    }
                }
                if (shouldShow) {
                    adminTasksHTML += createTaskCardHTML(taskId, task, false);
                }
            });
            
            promotionTasksSnapshot.forEach(doc => {
                const taskId = doc.id;
                if (!completedTasks[taskId]) {
                    const promo = doc.data();
                    const taskData = { title: promo.title, points: promo.pointsPerTask, url: promo.url, taskType: 'promotion' };
                    promotionTasksHTML += createTaskCardHTML(taskId, taskData, true);
                }
            });

            if (!adminTasksHTML && !promotionTasksHTML) {
                container.innerHTML = `<div class="no-tasks"><h3>No new tasks available in this category.</h3><p>Please check back later.</p></div>`;
                return;
            }
            
            container.innerHTML = `
                ${adminTasksHTML ? `<h2 class="section-title">Official Tasks</h2>${adminTasksHTML}` : ''}
                ${promotionTasksHTML ? `<h2 class="section-title">User Promotions</h2>${promotionTasksHTML}` : ''}
            `;
            
            attachEventListeners();

        } catch (error) {
            console.error("Error loading tasks:", error);
            container.innerHTML = `<div class="no-tasks"><h3>Could not load tasks.</h3></div>`;
        }
    }

    function createTaskCardHTML(taskId, task, isPromotion) {
        const isDaily = task.taskType === 'daily';
        
        // যেহেতু সম্পন্ন করা টাস্কগুলো দেখানোই হচ্ছে না, তাই isCompleted চেক করার আর প্রয়োজন নেই
        return `
            <div class="task-card ${isDaily ? 'daily' : ''}">
                <div class="task-info">
                    <h3>${task.title || 'Untitled Task'}</h3>
                    <p class="points">+${task.points || task.pointsPerTask || 0} Points</p>
                </div>
                <div class="task-actions">
                    <button class="task-btn join-btn" data-url="${task.url || ''}">Join</button>
                    <button class="task-btn verify-btn" 
                            data-task-id="${taskId}" 
                            data-is-promotion="${isPromotion}">
                        Verify
                    </button>
                </div>
            </div>`;
    }
    
    function attachEventListeners() {
        document.querySelectorAll('.join-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const url = e.target.dataset.url;
                if (url) tg.openLink(url);
                else tg.showAlert('Link for this task is not available.');
            });
        });

        document.querySelectorAll('.verify-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const buttonEl = e.target;
                const taskId = buttonEl.dataset.taskId;
                const isPromotion = buttonEl.dataset.isPromotion === 'true';
                const taskCard = buttonEl.closest('.task-card');

                buttonEl.disabled = true;
                buttonEl.innerText = 'Verifying...';

                try {
                    const response = await fetch('/api/verify-task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: String(userId), taskId, isPromotion })
                    });
                    
                    const result = await response.json();
                    tg.showAlert(result.message);

                    if (response.ok && result.success) {
                        // ভেরিফিকেশন সফল হলে কার্ডটি অ্যানিমেশনের সাথে মুছে ফেলা হচ্ছে
                        taskCard.style.transition = 'opacity 0.5s, transform 0.5s';
                        taskCard.style.opacity = '0';
                        taskCard.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            taskCard.remove();
                            // যদি আর কোনো টাস্ক না থাকে, তাহলে একটি বার্তা দেখানো হচ্ছে
                            if (!document.querySelector('.task-card')) {
                                document.getElementById('tasks-container').innerHTML = `<div class="no-tasks"><h3>No new tasks available.</h3></div>`;
                            }
                        }, 500);
                    } else {
                        buttonEl.disabled = false;
                        buttonEl.innerText = 'Verify';
                    }
                } catch (error) {
                    tg.showAlert('An error occurred during verification.');
                    buttonEl.disabled = false;
                    buttonEl.innerText = 'Verify';
                }
            });
        });
    }

    initializeApp();
});
</script>
</body>
</html>
