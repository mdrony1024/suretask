<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Tasks</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDKs ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body { margin: 0; padding: 20px; background-color: #12121f; color: white; font-family: 'Roboto', sans-serif; }
        .header { display: flex; align-items: center; margin-bottom: 25px; }
        .header h1 { margin: 0 0 0 15px; font-size: 24px; }
        .back-button { background: none; border: none; color: white; font-size: 28px; cursor: pointer; }
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: grid; grid-template-columns: 1fr auto; align-items: center; background-color: #1e1e3f; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .task-info { grid-column: 1 / -1; margin-bottom: 15px; }
        .task-info .title { font-weight: 500; font-size: 16px; }
        .task-info .points { font-size: 14px; color: #34d399; margin-top: 4px; }
        .task-actions { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { background-color: #4a00e0; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .verify-btn { background-color: #555; }
        .action-btn:disabled { background-color: #333; cursor: not-allowed; }
        #loading { text-align: center; margin-top: 50px; font-size: 18px; color: #aaa; }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="window.location.href='index.html'" class="back-button">&larr;</button>
        <h1>üìã Available Tasks</h1>
    </div>
    
    <ul id="taskList" class="task-list"></ul>
    <div id="loading">Loading tasks...</div>

    <script>
        let tg, firestoreDb, userId;

        window.addEventListener('load', async () => {
            tg = window.Telegram.WebApp;
            tg.ready();
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#12121f';

            try {
                // Firestore ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Config fetch failed');
                const firebaseConfig = await response.json();
                firebase.initializeApp(firebaseConfig);
                firestoreDb = firebase.firestore();
                
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    userId = tg.initDataUnsafe.user.id;
                    fetchCombinedTasks();
                } else {
                    document.getElementById('loading').innerText = 'Please open in Telegram.';
                }
            } catch (error) {
                document.getElementById('loading').innerText = `Initialization failed: ${error.message}`;
            }
        });

        async function fetchCombinedTasks() {
            const listElement = document.getElementById('taskList');
            const loadingElement = document.getElementById('loading');
            
            try {
                // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶Æ‡ßã‡¶∂‡¶® ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                const adminTasksPromise = firestoreDb.collection('tasks').where('isActive', '==', true).get();
                const userPromotionsPromise = firestoreDb.collection('promotions').where('status', '==', 'active').get();
                
                const [adminTasksSnapshot, userPromotionsSnapshot] = await Promise.all([adminTasksPromise, userPromotionsPromise]);

                loadingElement.style.display = 'none';

                let allTasks = [];

                adminTasksSnapshot.forEach(doc => {
                    allTasks.push({ id: doc.id, type: 'admin_task', ...doc.data() });
                });

                userPromotionsSnapshot.forEach(doc => {
                    allTasks.push({ id: doc.id, type: 'user_promotion', ...doc.data() });
                });
                
                // ‡¶¨‡¶æ‡¶ú‡ßá‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï‡¶ø‡¶Ç
                allTasks.sort((a, b) => (b.budget || b.points) - (a.budget || a.points));
                
                if (allTasks.length === 0) {
                    listElement.innerHTML = '<p style="text-align: center; color: #aaa;">No tasks available.</p>';
                    return;
                }

                allTasks.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.className = 'task-item';
                    
                    const points = task.rewardPerUser || task.points;
                    const actionButtonText = task.type === 'start_bot' ? 'Start' : 'Join';

                    listItem.innerHTML = `
                        <div class="task-info">
                            <div class="title">${escapeHTML(task.title)}</div>
                            <div class="points">+${points} Points</div>
                        </div>
                        <div class="task-actions">
                             <button class="action-btn" onclick="startTask('${task.link}')">${actionButtonText}</button>
                             <button class="verify-btn action-btn" id="btn-${task.id}" onclick="completeTask('${task.id}', '${task.type}', this)">Verify</button>
                        </div>
                    `;
                    listElement.appendChild(listItem);
                });

            } catch (error) {
                loadingElement.innerText = 'Failed to load tasks.';
                console.error('Error fetching tasks:', error);
            }
        }
        
        function startTask(link) {
            // ‡¶è‡¶ñ‡¶® ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ñ‡ßã‡¶≤‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá
            tg.openLink(link);
        }

        async function completeTask(taskId, taskType, button) {
            button.disabled = true;
            button.innerText = 'Verifying...';
            
            try {
                const response = await fetch('/api/complete-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, taskId: taskId, taskType: taskType })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                tg.HapticFeedback.notificationOccurred('success');
                button.innerText = 'Done ‚úî';
                button.style.backgroundColor = '#34d399'; // ‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶∞‡¶ô
                
            } catch (error) {
                 tg.HapticFeedback.notificationOccurred('error');
                 button.innerText = 'Retry';
                 button.disabled = false;
                 tg.showAlert(error.message || 'Verification failed.');
            }
        }

        function escapeHTML(str) {
            return str ? str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '';
        }
    </script>
</body>
</html>
